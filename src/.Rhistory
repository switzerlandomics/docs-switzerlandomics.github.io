tidy_dagitty() |>
node_status() |>
ggplot(
aes(x, y, xend = xend, yend = yend, color = status)
) +
geom_dag_edges() +
geom_dag_point() +
geom_dag_label_repel() +
scale_color_okabe_ito(na.value = "grey90") +
theme_dag() +
theme(legend.position = "none") +
coord_cartesian(clip = "off")
#| label: fig-net-data-dag
#| echo: false
#| fig.width: 7
#| fig.cap: >
#|   A proposed causal diagram of the effect of bed net use on malaria.
#|   This directed acyclic graph (DAG) states our assumption that bed net
#|   use causes a reduction in malaria risk. It also says that we assume:
#|   malaria risk is impacted by net usage, income, health, temperature,
#|   and insecticide resistance; net usage is impacted by income, health,
#|   temperature, eligibility for the free net program, and the number of
#|   people in a household; eligibility for the free net programs is impacted
#|   by income and the number of people in a household; and health is impacted
#|   by income.
library(ggdag, warn.conflicts = FALSE)
library(ggokabeito)
mosquito_dag <- dagify(
malaria_risk ~ net + income + health + temperature + resistance,
net ~ income + health + temperature + eligible + household,
eligible ~ income + household,
health ~ income,
exposure = "net",
outcome = "malaria_risk",
coords = list(
x = c(
malaria_risk = 7,
net = 3,
income = 4,
health = 5,
temperature = 6,
resistance = 8.5,
eligible = 2,
household = 1
),
y = c(
malaria_risk = 2,
net = 2,
income = 3,
health = 1,
temperature = 3,
resistance = 2,
eligible = 3,
household = 2
)
),
labels = c(
malaria_risk = "Risk of malaria",
net = "Mosquito net",
income = "Income",
health = "Health",
temperature = "Nighttime temperatures",
resistance = "Insecticide resistance",
eligible = "Eligible for program",
household = "Number in the household"
)
)
mosquito_dag |>
tidy_dagitty() |>
node_status() |>
ggplot(
aes(x, y, xend = xend, yend = yend, color = status)
) +
geom_dag_edges() +
geom_dag_point() +
geom_dag_label_repel() +
scale_color_okabe_ito(na.value = "grey90") +
theme_dag() +
theme(legend.position = "none") +
coord_cartesian(clip = "off")
rmarkdown::render("causal_inference_whole_game_raw.Rmd", output_file = "../pages/causal_inference_whole_game.md")
status("complete")
library(tidyverse)
# this is all a hack to make work with quick plotting
# TODO: when `geom_dag_label_repel2` exists, add to namespace as 1 then delete this first bit
# copied from source to avoid recursion issue in overriding in ggdag namsespace
ggdag_geom_dag_label_repel <- function(
mapping = NULL,
data = NULL,
parse = FALSE,
...,
box.padding = grid::unit(0.35, "lines"),
label.padding = grid::unit(0.25, "lines"),
point.padding = grid::unit(1.5, "lines"),
label.r = grid::unit(0.15, "lines"),
label.size = 0.25,
segment.color = "grey50",
segment.size = 0.5,
arrow = NULL,
force = 1,
max.iter = 2000,
nudge_x = 0,
nudge_y = 0,
na.rm = FALSE,
show.legend = NA,
inherit.aes = TRUE
) {
ggplot2::layer(
data = data,
mapping = mapping,
stat = ggdag:::StatNodesRepel,
geom = ggrepel::GeomLabelRepel,
position = "identity",
show.legend = show.legend,
inherit.aes = inherit.aes,
params = list(
parse = parse,
box.padding = box.padding,
label.padding = label.padding,
point.padding = point.padding,
label.r = label.r,
label.size = label.size,
segment.colour = segment.color %||%
segment.colour,
segment.size = segment.size,
arrow = arrow,
na.rm = na.rm,
force = force,
max.iter = max.iter,
nudge_x = nudge_x,
nudge_y = nudge_y,
segment.alpha = 1,
...
)
)
}
geom_dag_label_repel_internal <- function(..., seed = 10) {
ggdag_geom_dag_label_repel(
mapping = aes(x, y, label = label),
# TODO: make sure this looks ok. slightly different from above
box.padding = 2,
max.overlaps = Inf,
inherit.aes = FALSE,
family = getOption("book.base_family"),
seed = seed,
label.size = NA,
label.padding = 0.01
)
}
# apply to quick functions as well
assignInNamespace("geom_dag_label_repel", geom_dag_label_repel_internal, ns = "ggdag")
assignInNamespace("scale_color_hue", ggplot2::scale_color_discrete, ns = "ggplot2")
assignInNamespace("scale_edge_colour_hue", \(...) ggraph::scale_edge_colour_manual(..., values = ggokabeito::palette_okabe_ito()), ns = "ggraph")
# force ggraph to respect palette
assignInNamespace("scale_edge_color_discrete", ggokabeito::scale_edge_color_okabe_ito, ns = "ggraph")
# source(here::here("R/setup.R"))
options(
tidyverse.quiet = TRUE,
propensity.quiet = TRUE,
tipr.verbose = FALSE,
htmltools.dir.version = FALSE,
width = 55,
digits = 4,
ggplot2.discrete.colour = ggokabeito::palette_okabe_ito(),
ggplot2.discrete.fill = ggokabeito::palette_okabe_ito(),
ggplot2.continuous.colour = "viridis",
ggplot2.continuous.fill = "viridis",
book.base_family = "sans",
book.base_size = 14
)
library(ggplot2)
theme_set(
theme_minimal(
base_size = getOption("book.base_size"),
base_family = getOption("book.base_family")
) %+replace%
theme(
panel.grid.minor = element_blank(),
legend.position = "bottom"
)
)
theme_dag <- function() {
ggdag::theme_dag(base_family = getOption("book.base_family"))
}
geom_dag_label_repel <- function(..., seed = 10) {
ggdag_geom_dag_label_repel(
aes(x, y, label = label),
box.padding = 3.5,
inherit.aes = FALSE,
max.overlaps = Inf,
family = getOption("book.base_family"),
seed = seed,
label.size = NA,
label.padding = 0.1,
size = getOption("book.base_size") / 3,
...
)
}
est_ci <- function(.df, rsample = FALSE) {
if (!is.data.frame(.df) && is.numeric(.df)) {
return(
glue::glue("{round(.df[[1]], digits = 1)} (95% CI {round(.df[[2]], digits = 1)}, {round(.df[[3]], digits = 1)})")
)
}
if (rsample) {
glue::glue("{round(.df$.estimate, digits = 1)} (95% CI {round(.df$.lower, digits = 1)}, {round(.df$.upper, digits = 1)})")
} else {
glue::glue("{.df$estimate} (95% CI {.df$conf.low}, {.df$conf.high})")
}
}
# based on https://github.com/hadley/r-pkgs/blob/main/common.R
status <- function(type) {
status <- switch(
type,
unstarted = "is unstarted, but don't worry, it's on our roadmap",
polishing = "has its foundations written but is still undergoing changes",
wip = "is actively undergoing work and may be restructured or changed. It may also be incomplete",
complete = "is mostly complete, but we might make small tweaks or copyedits",
stop("Invalid `type`", call. = FALSE)
)
class <- switch(
type,
complete = ,
polishing = "callout-note",
wip = "callout-warning",
unstarted = "callout-warning"
)
knitr::asis_output(paste0(
"::: ",
class,
"\n",
"## Work-in-progress ðŸš§\n",
"You are reading the work-in-progress first edition of *Causal Inference in R*. ",
"This chapter ",
status,
". \n",
":::\n"
))
}
#| label: fig-malaria-risk-density
#| fig.cap: >
#| label: fig-malaria-risk-density
#| fig.cap: >
#|   A density plot of malaria risk for those who did and did not use nets.
#|   The risk of malaria is lower for those who use nets.
library(tidyverse)
library(causalworkshop)
net_data |>
ggplot(aes(malaria_risk, fill = net)) +
geom_density(color = NA, alpha = .8)
#| echo = FALSE
means <- net_data |>
group_by(net) |>
summarize(malaria_risk = mean(malaria_risk)) |>
pull(malaria_risk)
net_data |>
group_by(net) |>
summarize(malaria_risk = mean(malaria_risk))
library(broom)
net_data |>
lm(malaria_risk ~ net, data = _) |>
tidy()
#| label: fig-net-data-dag
#| echo: false
#| fig.width: 7
#| fig.cap: >
#|   A proposed causal diagram of the effect of bed net use on malaria.
#|   This directed acyclic graph (DAG) states our assumption that bed net
#|   use causes a reduction in malaria risk. It also says that we assume:
#|   malaria risk is impacted by net usage, income, health, temperature,
#|   and insecticide resistance; net usage is impacted by income, health,
#|   temperature, eligibility for the free net program, and the number of
#|   people in a household; eligibility for the free net programs is impacted
#|   by income and the number of people in a household; and health is impacted
#|   by income.
library(ggdag, warn.conflicts = FALSE)
library(ggokabeito)
mosquito_dag <- dagify(
malaria_risk ~ net + income + health + temperature + resistance,
net ~ income + health + temperature + eligible + household,
eligible ~ income + household,
health ~ income,
exposure = "net",
outcome = "malaria_risk",
coords = list(
x = c(
malaria_risk = 7,
net = 3,
income = 4,
health = 5,
temperature = 6,
resistance = 8.5,
eligible = 2,
household = 1
),
y = c(
malaria_risk = 2,
net = 2,
income = 3,
health = 1,
temperature = 3,
resistance = 2,
eligible = 3,
household = 2
)
),
labels = c(
malaria_risk = "Risk of malaria",
net = "Mosquito net",
income = "Income",
health = "Health",
temperature = "Nighttime temperatures",
resistance = "Insecticide resistance",
eligible = "Eligible for program",
household = "Number in the household"
)
)
mosquito_dag |>
tidy_dagitty() |>
node_status() |>
ggplot(
aes(x, y, xend = xend, yend = yend, color = status)
) +
geom_dag_edges() +
geom_dag_point() +
geom_dag_label_repel() +
scale_color_okabe_ito(na.value = "grey90") +
theme_dag() +
theme(legend.position = "none") +
coord_cartesian(clip = "off")
#| label: fig-net-data-confounding
#| echo: false
#| fig.width: 14
#| fig.height: 10
#| fig.cap: >
#|   In the proposed DAG, there are eight open pathways that contribute to the
#|   causal effect seen in the naive regression: the true effect (in green) of
#|   net usage on malaria risk and seven other confounding pathways (in orange).
#|   The naive estimate is wrong because it is a composite of all these effects.
glyph <- function(data, params, size) {
data$shape <- 15
data$size <- 12
ggplot2::draw_key_point(data, params, size)
}
mosquito_dag |>
dag_paths() |>
mutate(
effects = case_when(
set == "1" & path == "open path" ~ "true effect",
path == "open path" ~ "confounding effect",
TRUE ~ NA_character_
),
effects = factor(effects, c("true effect", "confounding effect"))
) |>
ggplot(aes(x = x, y = y, xend = xend, yend = yend, color = effects, alpha = path)) +
geom_dag_edges(aes(edge_alpha = path, edge_colour = effects), show.legend = FALSE) +
geom_dag_point(
data = function(.x) dplyr::filter(.x, is.na(path)),
key_glyph = glyph
) +
geom_dag_point(
data = function(.x) dplyr::filter(.x, !is.na(path)),
key_glyph = glyph
) +
facet_wrap(vars(fct_inorder(factor(set)))) +
expand_plot(
expand_x = expansion(c(0.25, 0.25)),
expand_y = expansion(c(0.1, 0.1))
) +
theme_dag() +
theme(
legend.position = "top",
legend.spacing.x = unit(8, "mm"),
legend.text = element_text(size = rel(2.5)),
legend.box.margin = margin(b = 20),
strip.text = element_blank()
) +
coord_cartesian(clip = "off") +
scale_alpha_manual(
drop = FALSE,
values = c("open path" = 1),
na.value = .5,
breaks = "open path"
) +
ggraph::scale_edge_alpha_manual(
drop = FALSE,
values = c("open path" = 1),
na.value = .5,
breaks = "open path"
) +
scale_color_okabe_ito(
name = NULL,
na.value = "grey90",
order = c(3, 6),
breaks = c("true effect", "confounding effect")
) +
scale_edge_color_okabe_ito(
name = NULL,
na.value = "grey90",
order = c(3, 6),
breaks = c("true effect", "confounding effect")
) +
guides(alpha = "none", edge_alpha = "none")
propensity_model <- glm(
net ~ income + health + temperature,
data = net_data,
family = binomial()
)
# the first six propensity scores
head(predict(propensity_model, type = "response"))
library(broom)
library(propensity)
net_data_wts <- propensity_model |>
augment(data = net_data, type.predict = "response") |>
# .fitted is the value predicted by the model
# for a given observation
mutate(wts = wt_ate(.fitted, net))
net_data_wts |>
select(net, .fitted, wts) |>
head()
#| label: fig-mirror-histogram-net-data-unweighted
#| fig.cap: >
#|   A mirrored histogram of the propensity scores of those who used nets (top, blue) versus those who did not use nets (bottom, orange). The range of propensity scores is similar between groups, with those who used nets slightly to the left of those who didn't, but the shapes of the distribution are different.
library(halfmoon)
ggplot(net_data_wts, aes(.fitted)) +
geom_mirror_histogram(
aes(fill = net),
bins = 50
) +
scale_y_continuous(labels = abs) +
labs(x = "propensity score")
The weighted propensity score creates a pseudo-population where the distributions are much more similar:
#| label: fig-love-plot-net-data
#| fig.cap: >
#|   A love plot representing the standardized mean differences (SMD) between exposure groups of three confounders: temperature, income, and health. Before weighting, there are considerable differences in the groups. After weighting, the confounders are much more balanced between groups.
plot_df <- tidy_smd(
net_data_wts,
c(income, health, temperature),
.group = net,
.wts = wts
)
ggplot(
plot_df,
aes(
x = abs(smd),
y = variable,
group = method,
color = method
)
) +
geom_love()
#| label: fig-ate-density-net-data
#| fig.cap: >
#|   A density plot of the average treatment effect (ATE) weights. The plot is skewed, with higher values towards 8. This may indicate a problem with the model, but the weights aren't so extreme to destabilize the variance of the estimate.
net_data_wts |>
ggplot(aes(wts)) +
geom_density(fill = "#CC79A7", color = NA, alpha = 0.8)
The weights in @fig-ate-density-net-data are skewed, but there are no outrageous values.
net_data_wts |>
lm(malaria_risk ~ net, data = _, weights = wts) |>
tidy(conf.int = TRUE)
#| include = FALSE
estimates <- net_data_wts |>
lm(malaria_risk ~ net, data = _, weights = wts) |>
tidy(conf.int = TRUE) |>
filter(term == "netTRUE") |>
select(estimate, starts_with("conf")) |>
mutate(across(everything(), round, digits = 1))
estimates
library(rsample)
rmarkdown::render("causal_inference_whole_game_raw.Rmd", output_file = "../pages/causal_inference_whole_game.md")
rmarkdown::render("causal_inference_whole_game.Rmd", output_file = "../pages/causal_inference_whole_game.md")
net_data_wts |>
lm(malaria_risk ~ net, data = ., weights = wts) |>
tidy(conf.int = TRUE)
net_data_wts |>
lm(malaria_risk ~ net, weights = wts) |>
tidy(conf.int = TRUE)
net_data_wts |>
lm(malaria_risk ~ net, data = _, weights = wts) |>
tidy(conf.int = TRUE)
net_data_wts
rmarkdown::render("causal_inference_whole_game.Rmd", output_file = "../pages/causal_inference_whole_game.md")
rmarkdown::render("causal_inference_whole_game.Rmd", output_file = "../pages/causal_inference_whole_game.md")
#| fig: fig-malaria-risk-density2
#| label: fig-malaria-risk-density
#| fig.cap: >
#|   A density plot of malaria risk for those who did and did not use nets.
#|   The risk of malaria is lower for those who use nets.
library(tidyverse)
library(causalworkshop)
net_data |>
ggplot(aes(malaria_risk, fill = net)) +
geom_density(color = NA, alpha = .8)
rmarkdown::render("causal_inference_whole_game.Rmd", output_file = "../pages/causal_inference_whole_game.md")
rmarkdown::render("causal_inference_whole_game.Rmd", output_file = "../pages/causal_inference_whole_game.md")
rmarkdown::render("causal_inference_whole_game.Rmd", output_file = "../pages/causal_inference_whole_game.md")
rmarkdown::render("causal_inference_whole_game.Rmd", output_file = "../pages/causal_inference_whole_game.md")
rmarkdown::render("causal_inference_whole_game.Rmd", output_file = "../pages/causal_inference_whole_game.md")
rmarkdown::render("causal_inference_whole_game.Rmd", output_file = "../pages/causal_inference_whole_game.md")
rmarkdown::render("causal_inference_whole_game.Rmd", output_file = "../pages/causal_inference_whole_game.md")
rmarkdown::render("file_count.Rmd", output_file = "../pages/file_count.md")
rmarkdown::render("file_count.Rmd", output_file = "../pages/file_count.md")
rmarkdown::render("documentation_log.Rmd", output_file = "../pages/documentation_log.md")
rmarkdown::render("documentation_log.Rmd", output_file = "../pages/documentation_log.md")
rmarkdown::render("documentation_log.Rmd", output_file = "../pages/documentation_log.md")
rmarkdown::render("Phoenix_Sepsis_Score_logic.Rmd", output_file = "../pages/Phoenix_Sepsis_Score_logic.md"
rmarkdown::render("Phoenix_Sepsis_Score_logic.Rmd", output_file = "../pages/Phoenix_Sepsis_Score_logic.md")
rmarkdown::render("phoenix_sepsis_score_logic.Rmd", output_file = "../pages/Phoenix_Sepsis_Score_logic.md")
getwd()
rmarkdown::render("sepsis_score_logic_phoenix.Rmd", output_file = "../pages/phoenix_sepsis_score_logic.md")
rmarkdown::render("sepsis_score_logic_phoenix.Rmd", output_file = "../pages/phoenix_sepsis_score_logic.md")
